#!/usr/bin/env perl

use v5.32;
use warnings;
use experimental 'signatures';  # stable since v5.36

use POSIX qw(ttyname);
use Getopt::Long qw(GetOptions :config posix_default no_ignore_case auto_help);
use Pod::Usage qw(pod2usage);

use FindBin qw($RealBin);
use lib "$RealBin/lib";
use RevBank::FileIO ();
use RevBank::Plugins ();
use RevBank::Shell qw(abort);

our $VERSION = "10.4.0";
$| = 1;

GetOptions(
    "datadir=s"   => \$ENV{REVBANK_DATADIR},
    "plugindir=s" => \$ENV{REVBANK_PLUGINDIR},
    "c|command=s" => \my $command,
    "with-lock"   => \my $with_lock,
) or pod2usage;
@ARGV and not $with_lock and pod2usage;

RevBank::FileIO::create_datadir;

if ($with_lock) {
    $command and die "--with-lock and --command can't be combined";
    @ARGV or die "No command line specified";

    RevBank::FileIO::with_lock {
        system @ARGV;
    };
    exit;
}

RevBank::Plugins::load;
RevBank::Plugins::call_hooks "startup";


if ($command) {
    RevBank::Shell::exec $command;
    exit;
}

if (not ttyname fileno STDIN) {
    warn "\e[31;1mNo controlling terminal, things will be borken!\n";
    warn "Use ssh -t (or RequestTTY in .ssh/config) for interactive sessions.\e[m\n";
}

RevBank::Shell::shell;

__END__

=head1 NAME

revbank - Prepaid bar tab payment system for hackerspaces 

=head1 SYNOPSIS

    revbank [--datadir <dir>] [--plugindir <dir>] [--command <cmd>]

    revbank [--datadir <dir>] --with-lock cmd arg...

=head1 DESCRIPTION

The main documentation is in C<README.md>.

=head1 AUTHOR

Juerd Waalboer <#####@juerd.nl>
